<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1, user-scalable=no">
  <title>åœ¨æ£®æ—é‚£é‚Š | åº«å­˜ç³»çµ±</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #2d6a4f;
      --accent-color: #52b788;
      --bg-color: #f4f9f5;
      --card-bg: #ffffff;
      --text-dark: #1b4332;
      --nav-height: 70px;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-dark);
      font-family: 'Noto Sans TC', sans-serif;
      padding-bottom: calc(var(--nav-height) + 20px);
      -webkit-tap-highlight-color: transparent;
    }

    /* Header */
    .header-bar {
      background: var(--primary-color);
      color: white;
      padding: 12px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(45, 106, 79, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      font-weight: 700;
      font-size: 1.2rem;
      letter-spacing: 1px;
    }

    /* User Badge (Clickable) */
    .user-badge {
      background-color: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 0.85rem;
      padding: 6px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }

    .user-badge:active {
      background-color: rgba(255, 255, 255, 0.4);
      transform: scale(0.95);
    }

    .user-badge i {
      margin-right: 5px;
      font-size: 1rem;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      margin-bottom: 12px;
    }

    /* User Selection Modal Cards */
    .user-card {
      border: 2px solid transparent;
      transition: all 0.2s;
      cursor: pointer;
      background: #f8f9fa;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }

    .user-card:hover {
      border-color: var(--accent-color);
      background: #fff;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .user-card:active {
      transform: scale(0.98);
      background: #e9ecef;
    }

    .user-avatar {
      font-size: 2.5rem;
      margin-bottom: 10px;
      display: block;
    }

    .user-name {
      font-weight: 700;
      color: var(--text-dark);
      font-size: 1.1rem;
    }

    /* Inventory Items */
    .category-header {
      font-size: 0.95rem;
      font-weight: 700;
      color: #95a5a6;
      margin: 24px 0 12px 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stock-num-clickable {
      font-size: 1.6rem;
      font-weight: 800;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .stock-num-clickable:active {
      background-color: rgba(0, 0, 0, 0.05);
      transform: scale(0.95);
    }

    .bg-low-stock {
      background-color: #fff0f3;
      border-left: 5px solid #d90429;
    }

    .bg-normal {
      border-left: 5px solid var(--accent-color);
    }

    .bg-eol {
      opacity: 0.7;
      filter: grayscale(1);
      border-left: 5px solid #95a5a6;
    }

    .text-danger-custom {
      color: #d90429;
    }

    /* Bottom Nav */
    .nav-bottom {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      padding: 10px 0 20px 0;
      z-index: 1020;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.03);
    }

    .nav-item-custom {
      text-align: center;
      color: #aeb6b3;
      text-decoration: none;
      font-size: 0.75rem;
      flex: 1;
      transition: color 0.2s;
    }

    .nav-item-custom i {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 2px;
    }

    .nav-item-custom.active {
      color: var(--primary-color);
      font-weight: 700;
    }

    /* Loading Overlay */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.85);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #loadingOverlay.visible {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>

<body>

  <div id="loadingOverlay">
    <div class="d-flex flex-column align-items-center">
      <div class="spinner-border text-success mb-2" role="status" style="width: 3rem; height: 3rem;"></div>
      <div class="text-success fw-bold">è™•ç†ä¸­...</div>
    </div>
  </div>

  <div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
        <div class="modal-body p-5">
          <div class="text-center mb-4">
            <h3 class="fw-bold" style="color: var(--primary-color);">ğŸ‘‹ è«‹é¸æ“‡æ‚¨çš„èº«åˆ†</h3>
            <p class="text-muted">ç³»çµ±å°‡æœƒè¨˜éŒ„æ‚¨çš„æ“ä½œ</p>
          </div>

          <div class="row g-3">
            <div class="col-12">
              <div class="user-card" onclick="selectUser('Joe')">
                <span class="user-avatar">ğŸ‘¨â€ğŸ’¼</span>
                <span class="user-name">Joe</span>
              </div>
            </div>
            <div class="col-6">
              <div class="user-card" onclick="selectUser('Nicole')">
                <span class="user-avatar">ğŸ™‹â€â™€ï¸</span>
                <span class="user-name">Nicole</span>
              </div>
            </div>
            <div class="col-6">
              <div class="user-card" onclick="selectUser('å“¡å·¥')">
                <span class="user-avatar">ğŸ™‹â€â™‚ï¸</span>
                <span class="user-name">å“¡å·¥</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="header-bar">
    <div class="header-title"><i class="bi bi-tree-fill me-2"></i>åœ¨æ£®æ—é‚£é‚Š</div>
    <div class="user-badge" onclick="openLoginModal()">
      <i class="bi bi-person-circle"></i>
      <span id="currentUserDisplay">æœªç™»å…¥</span>
    </div>
  </div>

  <div id="tab-picking" class="container mt-4 tab-content">
    <div class="mb-4 ps-1">
      <div class="d-flex align-items-center mb-3">
        <h4 class="fw-bold mb-0" style="color: var(--primary-color); letter-spacing: 1px;">
          <i class="bi bi-clipboard-data-fill me-2"></i>å¾…å‡ºè²¨æ¸…å–®
        </h4>
        <span id="pickingCountBadge" class="badge rounded-pill bg-danger ms-2 fs-6 shadow-sm"
          style="display:none; vertical-align: middle;">0 ç­†</span>
      </div>

      <div class="d-flex flex-column flex-md-row gap-3 align-items-md-center">
        <button type="button" onclick="manualImport()"
          class="btn btn-warning py-3 py-md-2 px-md-5 shadow-sm border-0 position-relative overflow-hidden flex-grow-1"
          style="border-radius: 12px; color: #1b4332; min-width: 200px;">
          <div class="d-flex align-items-center justify-content-center">
            <i class="bi bi-file-earmark-text-fill fs-4 fs-md-5 me-2"></i>
            <span class="fw-bold fs-5 fs-md-6">ç”¢ç”Ÿæ’¿è²¨å–®</span>
          </div>
          <div class="position-absolute top-0 start-0 w-100 h-100"
            style="background: linear-gradient(45deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%); pointer-events: none;">
          </div>
        </button>

        <button type="button" onclick="undoImport()" class="btn btn-outline-danger py-2 px-md-4 border-2 fw-bold"
          style="border-radius: 12px; font-size: 0.95rem; white-space: nowrap;">
          <i class="bi bi-arrow-counterclockwise me-1"></i>
          <span class="d-inline d-md-none">åŒ¯å…¥è³‡æ–™æœ‰èª¤ï¼Ÿå›å¾©ä¸Šä¸€æ­¥</span>
          <span class="d-none d-md-inline">å›å¾©ä¸Šä¸€æ­¥</span>
        </button>
      </div>

      <div class="d-flex justify-content-end mt-3 gap-2">
        <button type="button" onclick="copyPickingText()"
          class="btn btn-sm btn-light text-secondary border rounded-pill px-3">
          <i class="bi bi-clipboard me-1"></i>è¤‡è£½æ–‡å­—
        </button>
        <button type="button" onclick="loadPickingList()"
          class="btn btn-sm btn-light text-success border border-success rounded-pill px-3">
          <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°æ¸…å–®
        </button>
      </div>
    </div>

    <div id="pickingListContainer"></div>

    <div id="finishPickingBtnArea" class="mt-4 mb-5" style="display:none;">
      <div class="card p-3 border-success bg-light">
        <h6 class="text-success fw-bold"><i class="bi bi-check-circle-fill me-2"></i>ä½œæ¥­å®Œæˆ</h6>
        <p class="text-muted small mb-3">ç¢ºèªæ‰€æœ‰åŒ…è£¹çš†å·²æ’¿è²¨å®Œæˆï¼Ÿ</p>
        <button type="button" onclick="confirmShippingDone()" class="btn btn-success btn-lg w-100 shadow">
          å…¨éƒ¨å‡ºè²¨å®Œæˆ
        </button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="container mt-4 tab-content" style="display:none;">
    <div class="mb-4 ps-1">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0" style="color: var(--primary-color); letter-spacing: 1px;">
          <i class="bi bi-boxes me-2"></i>åº«å­˜ç¸½è¦½
        </h4>
        <button type="button" onclick="loadInventory()"
          class="btn btn-sm btn-light text-success border border-success rounded-pill px-3">
          <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
        </button>
      </div>
    </div>
    <div id="inventoryContainer"></div>
  </div>

  <div id="tab-production" class="container mt-4 tab-content" style="display:none;">
    <div class="mb-4 ps-1">
      <h4 class="fw-bold mb-0" style="color: var(--primary-color); letter-spacing: 1px;">
        <i class="bi bi-box-seam-fill me-2"></i>å…¥åº«ä½œæ¥­
      </h4>
      <p class="text-muted small mt-1 mb-0 ps-1">é‡å°å¯¦é«”å–®å“é€²è¡Œå…¥åº« (çµ„åˆåŒ…è«‹æ‹†è§£)</p>
    </div>

    <div class="card p-4 border-0 shadow-sm">
      <div class="mb-4">
        <label class="form-label fw-bold text-secondary">é¸æ“‡é …ç›®</label>
        <select id="skuSelect" class="form-select form-select-lg"
          style="border-radius: 12px; background-color: #f8f9fa; border: 1px solid #e9ecef;">
          <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
        </select>
      </div>

      <div class="mb-4">
        <label class="form-label fw-bold text-secondary">å…¥åº«æ•¸é‡</label>
        <div class="input-group input-group-lg shadow-sm" style="border-radius: 12px; overflow: hidden;">
          <button class="btn btn-light border" type="button" onclick="adjustQty(-1)" style="min-width: 60px;">
            <i class="bi bi-dash-lg text-primary"></i>
          </button>
          <input type="number" id="prodQty"
            class="form-control text-center fw-bold text-primary border-top border-bottom" value="1" min="1">
          <button class="btn btn-light border" type="button" onclick="adjustQty(1)" style="min-width: 60px;">
            <i class="bi bi-plus-lg text-primary"></i>
          </button>
        </div>
      </div>

      <button type="button" onclick="submitProduction()" class="btn btn-primary w-100 py-3 shadow-sm border-0"
        style="border-radius: 12px; background-color: var(--primary-color);">
        <div class="d-flex align-items-center justify-content-center">
          <i class="bi bi-arrow-down-circle-fill fs-4 me-2"></i>
          <span class="fw-bold fs-5">ç¢ºèªå…¥åº«</span>
        </div>
      </button>
    </div>
  </div>

  <div class="nav-bottom">
    <a href="#" class="nav-item-custom active" onclick="switchTab('picking', this); return false;"><i
        class="bi bi-clipboard-check-fill"></i>æ’¿è²¨</a>
    <a href="#" class="nav-item-custom" onclick="switchTab('inventory', this); return false;"><i
        class="bi bi-graph-up-arrow"></i>åº«å­˜</a>
    <a href="#" class="nav-item-custom" onclick="switchTab('production', this); return false;"><i
        class="bi bi-box-arrow-in-down"></i>å…¥åº«</a>
  </div>

  <script>
    document.body.addEventListener('touchmove', function (e) { if (e.target.closest('.tab-content')) return; e.preventDefault(); }, { passive: false });
    const Toast = Swal.mixin({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });

    // Global User Variables
    let currentUser = "";
    let loginModalInstance = null;

    document.addEventListener('DOMContentLoaded', function () {
      // Init Modal
      loginModalInstance = new bootstrap.Modal(document.getElementById('loginModal'));

      // Check User Login
      checkLoginStatus();

      loadPickingList();
      loadSkuList();
    });

    // --- Login Logic (V2.7) ---
    function checkLoginStatus() {
      const savedUser = localStorage.getItem('forest_user');
      if (savedUser) {
        // æœ‰ç´€éŒ„ï¼Œç›´æ¥é¡¯ç¤º
        updateUserDisplay(savedUser);
      } else {
        // æ²’ç´€éŒ„ï¼Œå¼·åˆ¶è·³å‡ºè¦–çª—
        openLoginModal();
      }
    }

    function openLoginModal() {
      loginModalInstance.show();
    }

    function selectUser(role) {
      localStorage.setItem('forest_user', role);
      updateUserDisplay(role);
      loginModalInstance.hide();
      Toast.fire({ icon: 'success', title: `æ­¡è¿å›ä¾†, ${role}!` });
    }

    function updateUserDisplay(name) {
      currentUser = name;
      document.getElementById('currentUserDisplay').innerText = name;
    }

    function getUser() {
      // Double check in case of error
      if (!currentUser) currentUser = localStorage.getItem('forest_user') || "Unknown";
      return currentUser;
    }

    // --- UI/UX Helpers ---
    function showLoading(show) { document.getElementById('loadingOverlay').classList.toggle('visible', show); }

    function switchTab(tab, el) {
      document.querySelectorAll('.tab-content').forEach(e => e.style.display = 'none');
      document.getElementById('tab-' + tab).style.display = 'block';
      document.querySelectorAll('.nav-item-custom').forEach(e => e.classList.remove('active'));
      el.classList.add('active');
      if (tab === 'picking') loadPickingList(); if (tab === 'inventory') loadInventory();
    }

    // --- Picking & Import Logic (V2.6) ---
    function manualImport() {
      Swal.fire({
        title: 'ç”¢ç”Ÿæ’¿è²¨å–®ï¼Ÿ',
        html: "é€™å°‡æœƒæ‰£é™¤åº«å­˜ã€‚<br>è«‹ç¢ºèªæš«å­˜å€å·²è²¼ä¸Šè³‡æ–™ã€‚",
        icon: 'question', showCancelButton: true, confirmButtonColor: '#ffc107', confirmButtonText: 'åŸ·è¡Œ',
        customClass: { confirmButton: 'text-dark fw-bold' }
      }).then((r) => {
        if (r.isConfirmed) {
          showLoading(true);
          google.script.run.withSuccessHandler(msg => {
            showLoading(false);
            if (msg.includes('âŒ') || msg.includes('âš ï¸')) Swal.fire('æ³¨æ„', msg, 'warning');
            else { Toast.fire({ icon: 'success', title: 'å®Œæˆ' }); loadPickingList(); }
          }).withFailureHandler(e => { showLoading(false); Swal.fire('Error', e.message, 'error') }).triggerManualImport(getUser());
        }
      });
    }

    function undoImport() {
      Swal.fire({
        title: 'è³‡æ–™æœ‰èª¤ï¼Ÿ',
        html: "é€™å°‡æœƒ<b>åˆªé™¤</b>å‰›å‰›åŒ¯å…¥çš„è¨‚å–®ç´€éŒ„<br>ä¸¦<b>å¾©åŸ</b>å°æ‡‰çš„åº«å­˜ã€‚",
        icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: 'å›å¾©ä¸Šä¸€æ­¥', focusCancel: true
      }).then((r) => {
        if (r.isConfirmed) {
          showLoading(true);
          google.script.run.withSuccessHandler(msg => {
            showLoading(false);
            if (msg.includes('âŒ') || msg.includes('âš ï¸')) Swal.fire('æ³¨æ„', msg, 'warning');
            else { Swal.fire('å·²å¾©åŸ', msg, 'success'); loadPickingList(); }
          }).withFailureHandler(e => { showLoading(false); Swal.fire('Error', e.message, 'error') }).triggerUndoImport(getUser());
        }
      });
    }

    // --- Inbound Logic ---
    function loadSkuList() {
      google.script.run.withSuccessHandler(data => {
        const select = document.getElementById('skuSelect'); select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡é …ç›®...</option>';
        let curCat = "", curGrp = null;
        data.forEach(item => {
          if (item.category !== curCat) { if (curGrp) select.appendChild(curGrp); curCat = item.category; curGrp = document.createElement('optgroup'); curGrp.label = curCat; }
          const opt = document.createElement('option'); opt.value = item.id; opt.text = item.name; curGrp.appendChild(opt);
        });
        if (curGrp) select.appendChild(curGrp);
      }).getSkuList();
    }
    function adjustQty(d) { const i = document.getElementById('prodQty'); let v = parseInt(i.value) || 0; v += d; if (v < 1) v = 1; i.value = v; }
    function submitProduction() {
      const s = document.getElementById('skuSelect').value, q = document.getElementById('prodQty').value, u = getUser();
      if (!s) return Toast.fire({ icon: 'warning', title: 'è«‹é¸æ“‡å•†å“' });
      showLoading(true);
      google.script.run.withSuccessHandler(() => { showLoading(false); Toast.fire({ icon: 'success', title: 'å…¥åº«æˆåŠŸ', text: `${u} å·²æ–°å¢ ${q}` }); document.getElementById('prodQty').value = 1; }).withFailureHandler(e => { showLoading(false); Swal.fire('Error', e.message, 'error') }).submitProduction(s, q, u);
    }

    // --- Inventory Logic ---
    function editStock(s, n, c) {
      Swal.fire({ title: 'ç›¤é»ä¿®æ­£', html: `<p>${n}</p><p>æ“ä½œè€…: ${getUser()}</p><label>å¯¦éš›æ•¸é‡:</label>`, input: 'number', inputValue: c, showCancelButton: true }).then(r => {
        if (r.isConfirmed && r.value != c) {
          // Optimistic UI
          const newQty = r.value;
          const el = document.querySelector(`[onclick="editStock('${s}','${n}',${c})"]`);
          if (el) { el.innerText = newQty; el.setAttribute('onclick', `editStock('${s}','${n}',${newQty})`); el.style.color = '#2d6a4f'; }

          google.script.run.withSuccessHandler(() => { Toast.fire({ icon: 'success', title: 'åº«å­˜å·²ä¿®æ­£' }); }).adjustInventory(s, newQty, getUser());
        }
      });
    }
    function loadInventory() { showLoading(true); google.script.run.withSuccessHandler(renderInventory).withFailureHandler(() => showLoading(false)).getInventoryStatus(); }
    function renderInventory(data) {
      showLoading(false); const c = document.getElementById('inventoryContainer'); if (!data) data = [];
      const cats = ['å•†å“', 'åŸæ–™', 'åŒ…æ'], g = {}, eol = [];
      data.forEach(i => { if (i.rawStatus.includes('Soft_Delete')) eol.push(i); else { const k = i.category || 'æœªåˆ†é¡'; if (!g[k]) g[k] = []; g[k].push(i); } });
      let h = '';
      const card = (i, e = false) => `<div class="card p-3 ${e ? 'bg-eol' : (i.isLow ? 'bg-low-stock' : 'bg-normal')}"><div class="d-flex justify-content-between align-items-center"><div><h6 class="mb-1 fw-bold text-dark">${i.name}</h6>${!e && i.isLow ? `<span class="badge bg-danger rounded-pill">ä½æ–¼æ°´ç·š: ${i.safetyStock}</span>` : ''}</div><div class="stock-num-clickable ${i.isLow ? 'text-danger-custom' : ''}" onclick="editStock('${i.id}','${i.name}',${i.stock})">${i.stock}</div></div></div>`;
      cats.forEach(k => { if (g[k]) { h += `<div class="category-header text-primary">${k}</div>`; g[k].forEach(i => h += card(i)); delete g[k]; } });
      for (const k in g) { h += `<div class="category-header">${k}</div>`; g[k].forEach(i => h += card(i)); }
      if (eol.length) { h += `<div class="category-header text-muted border-top pt-3">å·²ä¸‹æ¶</div>`; eol.forEach(i => h += card(i, true)); }
      c.innerHTML = h;
    }

    // --- Picking List Render ---
    function loadPickingList() {
      showLoading(true);
      google.script.run.withSuccessHandler(renderPickingList).withFailureHandler(() => showLoading(false)).getPickingList();
    }

    function renderPickingList(d) {
      showLoading(false);
      currentPickingData = d;
      const c = document.getElementById('pickingListContainer');
      const countBadge = document.getElementById('pickingCountBadge');

      if (!d || !d.length) {
        c.innerHTML = '<div class="text-center mt-5"><i class="bi bi-rocket-takeoff-fill display-1 text-success opacity-50"></i><h4 class="fw-bold mt-3" style="color:var(--primary-color);">ç›®å‰ç„¡å¾…å‡ºè²¨æ¸…å–®</h4><p class="text-muted">æº–å‚™è¿æ¥ä¸‹ä¸€æ³¢çˆ†å–®ï¼</p></div>';
        document.getElementById('finishPickingBtnArea').style.display = 'none';
        if (countBadge) countBadge.style.display = 'none';
        return;
      }

      // --- çµ±è¨ˆé‚è¼¯ (V2.9) ---
      let shopeeCount = 0;
      let wooCount = 0;

      d.forEach(row => {
        // row[4] æ˜¯å¹³å°æ¬„ä½ (Shopee / WooCommerce)
        const platform = row[4] ? row[4].toLowerCase() : "";
        if (platform.includes('shopee')) {
          shopeeCount++;
        } else if (platform.includes('woo')) {
          wooCount++;
        } else {
          // å¦‚æœæ²’æŠ“åˆ°å¹³å° (èˆŠè³‡æ–™)ï¼Œæš«æ™‚æ­¸é¡çµ¦è¦çš®æˆ–ä¸è¨ˆ? 
          // å‡è¨­é è¨­ç‚ºè¦çš®
          shopeeCount++;
        }
      });

      const total = d.length;

      // Update Badge (é¡¯ç¤ºè©³ç´°çµ±è¨ˆ)
      if (countBadge) {
        // æ ¼å¼: å®˜ç¶²: 1 | è¦çš®: 12 | ç¸½å…±: 13
        countBadge.innerHTML = `å®˜ç¶²: ${wooCount} <span class="mx-1 opacity-50">|</span> è¦çš®: ${shopeeCount} <span class="mx-1 opacity-50">|</span> ç¸½å…±: ${total} ç­†`;
        countBadge.className = "badge bg-danger ms-2 shadow-sm align-middle"; // ç¢ºä¿æ¨£å¼æ­£ç¢º
        countBadge.style.display = 'inline-block';
        countBadge.style.fontWeight = '500';
        countBadge.style.letterSpacing = '0.5px';
      }

      document.getElementById('finishPickingBtnArea').style.display = 'block';

      // Render Cards
      c.innerHTML = d.map(r => `
        <div class="card p-3">
          <h5 class="fw-bold mb-2" style="color:#2d6a4f; line-height:1.4">${r[1]}</h5>
          <div class="d-flex justify-content-between text-muted small border-top pt-2">
            <div>
              <i class="bi bi-upc-scan me-1"></i>${r[2]} 
              </div>
            <span class="badge bg-light text-dark border">${r[3]}</span>
          </div>
        </div>
      `).join('');
    }
    function copyPickingText() { if (!currentPickingData) return; navigator.clipboard.writeText(currentPickingData.map(r => r[1]).join('\n')).then(() => Toast.fire({ icon: 'success', title: 'å·²è¤‡è£½' })); }
    function confirmShippingDone() { Swal.fire({ title: 'ç¢ºèªå‡ºè²¨å®Œæˆï¼Ÿ', icon: 'warning', showCancelButton: true, confirmButtonText: 'æ˜¯çš„' }).then(r => { if (r.isConfirmed) { showLoading(true); google.script.run.withSuccessHandler(() => { showLoading(false); Toast.fire({ icon: 'success', title: 'å®Œæˆ' }); loadPickingList(); }).clearStagingArea(); } }); }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>