<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1, user-scalable=no">
  <title>åœ¨æ£®æ—é‚£é‚Š | åº«å­˜ç³»çµ±</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #2d6a4f;
      --accent-color: #52b788;
      --bg-color: #f4f9f5;
      --card-bg: #ffffff;
      --text-dark: #1b4332;
      --nav-height: 70px;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-dark);
      font-family: 'Noto Sans TC', sans-serif;
      padding-bottom: calc(var(--nav-height) + 20px);
      -webkit-tap-highlight-color: transparent;
    }

    /* Header & User Selector */
    .header-bar {
      background: var(--primary-color);
      color: white;
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(45, 106, 79, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: 1px;
    }

    .user-select {
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 0.85rem;
      padding: 5px 10px;
      border-radius: 20px;
      appearance: none;
      -webkit-appearance: none;
      text-align: center;
      cursor: pointer;
      font-weight: 500;
    }

    .user-select:focus {
      outline: none;
      background-color: rgba(255, 255, 255, 0.3);
    }

    .user-select option {
      color: #333;
    }

    /* Common UI */
    .card {
      background: var(--card-bg);
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
      margin-bottom: 12px;
    }

    .btn-primary-forest {
      background: var(--primary-color);
      border: none;
      border-radius: 12px;
      padding: 12px;
      font-weight: 700;
      width: 100%;
      color: white;
      box-shadow: 0 4px 12px rgba(45, 106, 79, 0.3);
    }

    .btn-primary-forest:active {
      transform: translateY(2px);
    }

    /* Input Group */
    .input-group-custom {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      overflow: hidden;
      display: flex;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .btn-qty {
      background: #f8f9fa;
      border: none;
      color: var(--primary-color);
      font-weight: bold;
      width: 60px;
      font-size: 1.5rem;
    }

    .input-qty {
      border: none;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
      width: 100%;
    }

    .input-qty:focus {
      outline: none;
      background: #fafafa;
    }

    /* Inventory Items */
    .category-header {
      font-size: 0.9rem;
      font-weight: 700;
      color: #95a5a6;
      margin: 20px 0 10px 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stock-num-clickable {
      font-size: 1.5rem;
      font-weight: 800;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .bg-low-stock {
      background-color: #fff0f3;
      border-left: 5px solid #d90429;
    }

    .bg-normal {
      border-left: 5px solid var(--accent-color);
    }

    .bg-eol {
      opacity: 0.6;
      filter: grayscale(1);
      border-left: 5px solid #95a5a6;
    }

    .text-danger-custom {
      color: #d90429;
    }

    /* Nav */
    .nav-bottom {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      padding: 10px 0 15px 0;
      z-index: 1020;
      display: flex;
      justify-content: space-around;
    }

    .nav-item-custom {
      text-align: center;
      color: #95a5a6;
      text-decoration: none;
      font-size: 0.75rem;
      flex: 1;
    }

    .nav-item-custom i {
      font-size: 1.4rem;
      display: block;
      margin-bottom: 2px;
    }

    .nav-item-custom.active {
      color: var(--primary-color);
      font-weight: 600;
    }

    /* Loading */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #loadingOverlay.visible {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>

<body>

  <div id="loadingOverlay">
    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="header-bar">
    <div class="header-title"><i class="bi bi-tree-fill me-2"></i>åœ¨æ£®æ—é‚£é‚Š</div>
    <select id="userSelector" class="user-select" onchange="saveUser()">
      <option value="è€é—†">ğŸ‘¨â€ğŸ’¼ è€é—†</option>
      <option value="å“¡å·¥A">ğŸ™‹â€â™‚ï¸ å“¡å·¥A</option>
      <option value="å“¡å·¥B">ğŸ™‹â€â™€ï¸ å“¡å·¥B</option>
    </select>
  </div>

  <div id="tab-picking" class="container mt-4 tab-content">
    <div class="d-flex justify-content-between align-items-center mb-3 ps-1">
      <h6 class="text-muted mb-0">å¾…å‡ºè²¨æ¸…å–®</h6>
      <div>
        <!-- V2.3: ç§»é™¤åŒ¯å…¥æŒ‰éˆ• -->
        <button type="button" onclick="copyPickingText()"
          class="btn btn-sm btn-outline-secondary rounded-pill px-3 me-2">
          <i class="bi bi-clipboard me-1"></i>è¤‡è£½
        </button>
        <button type="button" onclick="loadPickingList()" class="btn btn-sm btn-outline-success rounded-pill px-3">
          <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
        </button>
      </div>
    </div>
    <div id="pickingListContainer"></div>
    <div id="finishPickingBtnArea" class="mt-4 mb-5" style="display:none;">
      <div class="card p-3 border-success bg-light">
        <h6 class="text-success fw-bold"><i class="bi bi-check-circle-fill me-2"></i>ä½œæ¥­å®Œæˆ</h6>
        <p class="text-muted small mb-3">ç¢ºèªæ‰€æœ‰åŒ…è£¹çš†å·²æ’¿è²¨å®Œæˆï¼Ÿ</p>
        <button type="button" onclick="confirmShippingDone()" class="btn btn-success btn-lg w-100 shadow">
          å…¨éƒ¨å‡ºè²¨å®Œæˆ
        </button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="container mt-4 tab-content" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3 ps-1">
      <h6 class="text-muted mb-0">åº«å­˜ç¸½è¦½</h6>
      <button type="button" onclick="loadInventory()" class="btn btn-sm btn-outline-success rounded-pill px-3">
        <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
      </button>
    </div>
    <div id="inventoryContainer"></div>
  </div>

  <div id="tab-production" class="container mt-4 tab-content" style="display:none;">
    <h6 class="text-muted mb-3 ps-1">å…¥åº«ä½œæ¥­ (å¯¦é«”å–®å“)</h6>
    <div class="card p-4">
      <div class="mb-4">
        <label class="form-label fw-bold">é¸æ“‡é …ç›®</label>
        <select id="skuSelect" class="form-select form-select-lg" style="border-radius: 12px;">
          <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="form-label fw-bold">å…¥åº«æ•¸é‡</label>
        <div class="input-group-custom">
          <button class="btn btn-qty" type="button" onclick="adjustQty(-1)">-</button>
          <input type="number" id="prodQty" class="form-control input-qty" value="1" min="1">
          <button class="btn btn-qty" type="button" onclick="adjustQty(1)">+</button>
        </div>
      </div>
      <button type="button" onclick="submitProduction()" class="btn-primary-forest">
        ç¢ºèªå…¥åº« <i class="bi bi-arrow-down-circle ms-2"></i>
      </button>
    </div>
  </div>

  <div class="nav-bottom">
    <a href="#" class="nav-item-custom active" onclick="switchTab('picking', this); return false;"><i
        class="bi bi-clipboard-check-fill"></i>æ’¿è²¨</a>
    <a href="#" class="nav-item-custom" onclick="switchTab('inventory', this); return false;"><i
        class="bi bi-graph-up-arrow"></i>åº«å­˜</a>
    <a href="#" class="nav-item-custom" onclick="switchTab('production', this); return false;"><i
        class="bi bi-box-arrow-in-down"></i>å…¥åº«</a>
  </div>

  <script>
    document.body.addEventListener('touchmove', function (e) { if (e.target.closest('.tab-content')) return; e.preventDefault(); }, { passive: false });

    // Toast Configuration
    const Toast = Swal.mixin({
      toast: true, position: 'bottom-end', showConfirmButton: false, timer: 3000,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
      }
    });

    document.addEventListener('DOMContentLoaded', function () {
      loadUser(); // Load saved user
      loadPickingList();
      loadSkuList();
    });

    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      if (show) overlay.classList.add('visible'); else overlay.classList.remove('visible');
    }

    // User LocalStorage Logic
    function saveUser() {
      const user = document.getElementById('userSelector').value;
      localStorage.setItem('forest_user', user);
      Toast.fire({ icon: 'info', title: `å·²åˆ‡æ›ç‚º: ${user}` });
    }

    function loadUser() {
      const saved = localStorage.getItem('forest_user');
      if (saved) document.getElementById('userSelector').value = saved;
    }

    function getUser() {
      return document.getElementById('userSelector').value;
    }

    function switchTab(tabName, navElement) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.getElementById('tab-' + tabName).style.display = 'block';
      document.querySelectorAll('.nav-item-custom').forEach(el => el.classList.remove('active'));
      navElement.classList.add('active');
      if (tabName === 'picking') loadPickingList();
      if (tabName === 'inventory') loadInventory();
    }

    // --- Inbound Logic (Modified) ---
    function loadSkuList() {
      google.script.run.withSuccessHandler(function (data) {
        const select = document.getElementById('skuSelect');
        select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡é …ç›®...</option>';
        let currentCategory = "", currentGroup = null;
        data.forEach(item => {
          if (item.category !== currentCategory) {
            if (currentGroup) select.appendChild(currentGroup);
            currentCategory = item.category;
            currentGroup = document.createElement('optgroup');
            currentGroup.label = currentCategory;
          }
          const option = document.createElement('option');
          option.value = item.id;
          option.text = item.name;
          currentGroup.appendChild(option);
        });
        if (currentGroup) select.appendChild(currentGroup);
      }).getSkuList();
    }

    function adjustQty(delta) {
      const input = document.getElementById('prodQty');
      let val = parseInt(input.value) || 0;
      val += delta;
      if (val < 1) val = 1;
      input.value = val;
    }

    function submitProduction() {
      const sku = document.getElementById('skuSelect').value;
      const qty = document.getElementById('prodQty').value;
      const user = getUser();

      if (!sku) return Toast.fire({ icon: 'warning', title: 'è«‹é¸æ“‡å•†å“' });

      showLoading(true);
      google.script.run
        .withSuccessHandler(function () {
          showLoading(false);
          // ä½¿ç”¨ Toast æ›¿ä»£ Alert
          Toast.fire({ icon: 'success', title: 'å…¥åº«æˆåŠŸ', text: `${user} å·²æ–°å¢ ${qty} å–®ä½` });
          document.getElementById('prodQty').value = 1;
        })
        .withFailureHandler(function (err) {
          showLoading(false);
          Swal.fire('éŒ¯èª¤', err.message, 'error');
        })
        .submitProduction(sku, qty, user); // å‚³é user
    }

    // --- Inventory Logic (Modified) ---
    function editStock(sku, name, currentQty) {
      const user = getUser();
      Swal.fire({
        title: 'åº«å­˜ç›¤é»ä¿®æ­£',
        html: `<p class="text-muted small mb-2">${name}</p>
                 <p class="fw-bold">æ“ä½œè€…: ${user}</p>
                 <label class="form-label">è«‹è¼¸å…¥å¯¦éš›ç›¤é»æ•¸é‡ï¼š</label>`,
        input: 'number', inputValue: currentQty,
        showCancelButton: true, confirmButtonText: 'ä¿®æ­£åº«å­˜', confirmButtonColor: '#2d6a4f',
        inputValidator: (value) => { if (!value) return 'è«‹è¼¸å…¥æ•¸å­—'; }
      }).then((result) => {
        if (result.isConfirmed) {
          const newQty = result.value;
          if (newQty == currentQty) return;
          showLoading(true);
          google.script.run
            .withSuccessHandler(() => {
              showLoading(false);
              Toast.fire({ icon: 'success', title: 'ä¿®æ­£å®Œæˆ', text: `åº«å­˜å·²æ›´æ–°ç‚º ${newQty}` });
              loadInventory();
            })
            .withFailureHandler(err => {
              showLoading(false);
              Swal.fire('éŒ¯èª¤', err.message, 'error');
            })
            .adjustInventory(sku, newQty, user); // å‚³é user
        }
      });
    }

    function loadInventory() {
      showLoading(true);
      google.script.run.withSuccessHandler(renderInventory).withFailureHandler(() => showLoading(false)).getInventoryStatus();
    }

    function renderInventory(data) {
      showLoading(false);
      if (!data) data = [];
      const container = document.getElementById('inventoryContainer');
      const priorityOrder = ['å•†å“', 'åŸæ–™', 'åŒ…æ'];
      const grouped = {}; const eolItems = [];

      data.forEach(item => {
        if (item.rawStatus.includes('Soft_Delete')) eolItems.push(item);
        else {
          const cat = item.category || 'æœªåˆ†é¡';
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(item);
        }
      });

      let html = '';
      const createCard = (item, isEOL = false) => {
        let cardClass = item.isLow ? 'bg-low-stock' : 'bg-normal';
        if (isEOL) cardClass = 'bg-eol';
        return `
            <div class="card p-3 ${cardClass}">
              <div class="d-flex justify-content-between align-items-center">
                <div style="flex: 1;">
                  <h6 class="mb-1 fw-bold text-dark">${item.name}</h6>
                  ${isEOL ? '<span class="badge bg-secondary rounded-pill" style="font-size:0.6rem;">å·²ä¸‹æ¶</span>' : ''}
                  ${!isEOL && item.isLow ? `<span class="badge bg-danger rounded-pill" style="font-size:0.6rem;">ä½æ–¼æ°´ç·š: ${item.safetyStock}</span>` : ''}
                </div>
                <div class="text-end ps-3">
                  <div class="stock-num-clickable ${item.isLow ? 'text-danger-custom' : 'text-dark'}" 
                       onclick="editStock('${item.id}', '${item.name}', ${item.stock})">
                    ${item.stock}
                  </div>
                </div>
              </div>
            </div>`;
      };

      priorityOrder.forEach(cat => {
        if (grouped[cat]) {
          html += `<div class="category-header text-primary"><i class="bi bi-bookmark-fill me-1"></i>${cat}</div>`;
          grouped[cat].forEach(item => html += createCard(item));
          delete grouped[cat];
        }
      });
      for (const [cat, items] of Object.entries(grouped)) {
        html += `<div class="category-header text-secondary">${cat}</div>`;
        items.forEach(item => html += createCard(item));
      }
      if (eolItems.length > 0) {
        html += `<div class="category-header text-muted border-top pt-3 mt-3">å·²ä¸‹æ¶å•†å“</div>`;
        eolItems.forEach(item => html += createCard(item, true));
      }
      container.innerHTML = html;
    }

    // --- Picking Logic (Unchanged but included for completeness) ---
    let currentPickingData = [];
    function loadPickingList() {
      showLoading(true);
      google.script.run.withSuccessHandler(renderPickingList).withFailureHandler(() => showLoading(false)).getPickingList();
    }
    function renderPickingList(data) {
      showLoading(false);
      currentPickingData = data;
      const container = document.getElementById('pickingListContainer');
      const btnArea = document.getElementById('finishPickingBtnArea');
      if (!data || data.length === 0) {
        container.innerHTML = `<div class="text-center mt-5"><div class="mb-3"><i class="bi bi-rocket-takeoff-fill display-1 text-success opacity-50" style="font-size: 4rem;"></i></div><h4 class="fw-bold" style="color: var(--primary-color);">ç›®å‰ç„¡å¾…å‡ºè²¨æ¸…å–®</h4><p class="text-muted mt-2">æ‰€æœ‰è¨‚å–®å·²å…¨æ•¸æ¶ˆåŒ–å®Œç•¢<br><span class="fw-bold text-dark">ğŸ’ª è“„å‹¢å¾…ç™¼ï¼Œæº–å‚™è¿æ¥ä¸‹ä¸€æ³¢çˆ†å–®ï¼</span></p></div>`;
        if (btnArea) btnArea.style.display = 'none';
        return;
      }
      if (btnArea) btnArea.style.display = 'block';
      let html = '';
      data.forEach(row => {
        html += `<div class="card p-3"><div class="d-flex justify-content-between align-items-start"><h5 class="fw-bold" style="color: var(--primary-color); line-height: 1.4;">${row[1]}</h5></div><div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top border-light"><div class="text-muted small"><i class="bi bi-upc-scan me-1"></i>${row[2]}</div><span class="badge bg-light text-dark border">${row[3]}</span></div></div>`;
      });
      container.innerHTML = html;
    }
    function copyPickingText() {
      if (!currentPickingData || currentPickingData.length === 0) return Toast.fire({ icon: 'info', title: 'æ²’æœ‰è³‡æ–™' });
      let text = currentPickingData.map(row => row[1]).join('\n');
      navigator.clipboard.writeText(text).then(() => Toast.fire({ icon: 'success', title: 'å·²è¤‡è£½', text: 'è«‹è²¼åˆ° Line å›å ±' }));
    }
    function confirmShippingDone() {
      Swal.fire({
        title: 'ç¢ºèªå‡ºè²¨å®Œæˆï¼Ÿ', text: "é€™å°‡æœƒæ¸…ç©ºã€Œæ•¸æ“šæš«å­˜å€ã€ï¼Œè«‹ç¢ºä¿å·²æ ¸å°ç„¡èª¤ï¼",
        icon: 'warning', showCancelButton: true, confirmButtonColor: '#2d6a4f', confirmButtonText: 'æ˜¯çš„ï¼Œæ¸…ç©ºï¼'
      }).then((result) => {
        if (result.isConfirmed) {
          showLoading(true);
          google.script.run.withSuccessHandler(() => {
            showLoading(false);
            Toast.fire({ icon: 'success', title: 'å®Œæˆ', text: 'æš«å­˜å€å·²æ¸…ç©º' });
            loadPickingList();
          }).clearStagingArea();
        }
      });
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>